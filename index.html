<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>service worker</title>
    <link rel="stylesheet" href="/demo01/style.css">
</head>

<body>
    <h1>Service Worker 注册过程</h1>

    <p>可以在<a href="https://www.chromestatus.com/feature/6561526227927040">Chrome 40+</a>上运行</p>

    <p>这个示例提供了一些介绍，关于事件在一个典型的sevice worker中注册的过程。脚本代码<code>service-worker.js</code>代码。 多次注册相同的脚本是安全的,所以没有必要检查以前的注册。</p>

    <p>
        从下面的注册页面可以找到各个部分的service worker。此外,点击下面的"inspect" 链接来查看各种操作日志语句，
        <code><a href="service-worker.js">service-worker.js</a></code> 脚本正在运行.
    </p>

    <div class="output">
        <h2>Service Worker 的可用性</h2>
        <p>
            Service Workers <strong id="availability"></strong> 可以在你的浏览器运行.
            <em>(检查是否 <code>'serviceWorker' in navigator</code>.)</em>
        </p>

        <h2>页面是否已经被Service Worker所控制?</h2>
        <p>
            页面 <strong id="controlled"></strong> 当前已被控制.
            <em>(检查是否 <code>navigator.serviceWorker.controller</code> 已经被设置.)</em>
        </p>

        <h2>当前注册信息</h2>
        <p>
            <code>navigator.serviceWorker.register()</code> 的调用 <strong id="register"></strong>.
        </p>
        <p>
            当前的注册代表了<strong id="kind"></strong> service worker.
        </p>
        <p>
            <em>小提示:</em>当一个新的service worker被注册后处于<code>activated</code> 激活状态时, 刷新页面是service worker得到控制.当然了，你还可以刷新时按住shift键重新加载一个没有被service
            worker控制的页面。
        </p>
        <p>当前注册的service worker的状态的转换</p>
        <ol id="states"></ol>
    </div>

    <script>
        function logState(state) {
            var liElement = document.createElement('li');
            liElement.textContent = state;
            document.querySelector('#states').appendChild(liElement);
        }


        if ('serviceWorker' in navigator) {
            // 当前浏览器已经支持service workers.

            document.querySelector('#availability').textContent = 'are';

            // 通过当前页面的navigation来检查当前是否有service worker的处理程序
            // navigator.serviceWorker.controlled
            document.querySelector('#controlled').textContent = navigator.serviceWorker.controller ? 'is' : 'is not';

            // 使用scope属性可以用当前目录 './' 覆盖根目录 '/'，所以注册范围是当前目录和旗下的所有子目录。
            navigator.serviceWorker.register('service-worker.js', {
                scope: './'
            }).then(function (registration) {

                // 到这里 service worker 已经被注册
                // 此时 service worker不会再处理任何请求，
                // 除非这个页面或它的实例被关闭或者重新加载
                document.querySelector('#register').textContent = 'succeeded';

                var serviceWorker;
                if (registration.installing) {
                    serviceWorker = registration.installing;
                    document.querySelector('#kind').textContent = 'installing';
                } else if (registration.waiting) {
                    serviceWorker = registration.waiting;
                    document.querySelector('#kind').textContent = 'waiting';
                } else if (registration.active) {
                    serviceWorker = registration.active;
                    document.querySelector('#kind').textContent = 'active';
                }

                if (serviceWorker) {
                    logState(serviceWorker.state);
                    serviceWorker.addEventListener('statechange', function (e) {
                        logState(e.target.state);
                    });
                }
            }).catch(function (error) {

                // 在注册的时候出了问题
                // service-worker.js 文件中存在不可用或包含语法错误
                document.querySelector('#register').textContent = 'failed: ' + error;
            });
        } else {
            // 当前浏览器不支持service workers
            document.querySelector('#availability').textContent = 'are not';
        }
    </script>

</body>

</html>